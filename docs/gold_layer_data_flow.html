<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold Layer Data Flow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: { useMaxWidth: false, htmlLabels: true }
        });
    </script>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        .mermaid { display: flex; justify-content: center; }
    </style>
</head>
<body>
    <h1>Huntington Data Lake: Gold Layer Data Flow</h1>
    <div class="mermaid">
graph TD
    %% Use subgraphs to organize layers
    
    subgraph Sources
        ClinisysDB[("Clinisys SQL Server")]
        EmbryoscopeAPI[("Embryoscope API")]
        ExcelFiles[("Planilha Embriologia Excel")]
    end
    
    subgraph Bronze_Layer
        B_Clini[("bronze.clinisys_*")]
        B_Planilha[("bronze.planilha_embriologia_*")]
    end
    
    subgraph Silver_Layer
        S_Clini_Views[("silver.clinisys_views")]
        note_views["view_tratamentos<br/>view_pacientes<br/>view_unidades<br/>view_medicos<br/>view_congelamentos_*<br/>view_extrato_atendimentos"]
        
        S_Planilha[("silver.planilha_embriologia")]
    end
    
    subgraph Gold_Layer
        %% Core Embryology Tables
        G_Embryo_Embrioes[("gold.embryoscope_embrioes")]
        G_Clini_Embrioes[("gold.clinisys_embrioes")]
        G_Emb_Clini_Comb[("gold.embryoscope_clinisys_combined")]
        G_Plan_Emb_Comb[("gold.planilha_embryoscope_combined")]
        G_Data_Ploidia[("gold.data_ploidia")]
        
        %% Timeline Tables
        G_All_Timeline[("gold.all_patients_timeline")]
        G_Patient_Info[("gold.patient_info")]
        
        %% Other Timelines (derived from same logic/sources as All Timeline)
        G_Biopsy_Timeline[("gold.biopsy_pgta_timeline")]
        G_Consultas_Timeline[("gold.consultas_timeline")]
        G_Cryo_Timeline[("gold.cryopreservation_events_timeline")]
        G_Freeze_Timeline[("gold.embryo_freeze_timeline")]
        G_Embryo_Timeline[("gold.embryoscope_timeline")]
        
        %% Finops
        G_Finops[("gold.finops_summary")]
    end

    %% Flows - Ingestion
    ClinisysDB --> B_Clini
    ExcelFiles --> B_Planilha
    
    %% Flows - Bronze to Silver
    B_Clini --> S_Clini_Views
    B_Planilha --> S_Planilha
    
    %% Flows - Silver/API to Gold (Embryology)
    EmbryoscopeAPI --> G_Embryo_Embrioes
    S_Clini_Views --> G_Clini_Embrioes
    
    %% Flows - Merges
    G_Clini_Embrioes --> G_Emb_Clini_Comb
    G_Embryo_Embrioes --> G_Emb_Clini_Comb
    
    G_Emb_Clini_Comb --> G_Plan_Emb_Comb
    S_Planilha --> G_Plan_Emb_Comb
    
    %% Flows - Data Ploidia
    G_Emb_Clini_Comb --> G_Data_Ploidia
    S_Clini_Views -->|.view_tratamentos| G_Data_Ploidia
    
    %% Flows - Timelines
    S_Clini_Views -->|.view_tratamentos<br/>.view_extrato_atendimentos<br/>.view_congelamentos<br/>etc.| G_All_Timeline
    
    G_All_Timeline --> G_Patient_Info
    S_Clini_Views -->|.view_medicos<br/>.view_pacientes| G_Patient_Info
    
    %% Specific Timelines (simplified flow)
    S_Clini_Views --> G_Biopsy_Timeline
    S_Clini_Views --> G_Consultas_Timeline
    S_Clini_Views --> G_Cryo_Timeline
    S_Clini_Views --> G_Freeze_Timeline
    
    %% Note: Embryoscope Timeline merges Clini + Embryoscope data usually
    S_Clini_Views --> G_Embryo_Timeline
    G_Embryo_Embrioes --> G_Embryo_Timeline
    
    %% Finops
    S_Clini_Views --> G_Finops
    G_All_Timeline -.-> G_Finops


    %% Styling
    style Sources fill:#f9f,stroke:#333
    style Bronze_Layer fill:#e1f5fe,stroke:#333
    style Silver_Layer fill:#e0e0e0,stroke:#333
    style Gold_Layer fill:#fff9c4,stroke:#333
    
    style G_Emb_Clini_Comb fill:#ffd54f,stroke:#fbc02d,stroke-width:2px
    style G_Plan_Emb_Comb fill:#ffd54f,stroke:#fbc02d,stroke-width:2px
    style G_Data_Ploidia fill:#ffd54f,stroke:#fbc02d,stroke-width:2px
    style G_All_Timeline fill:#ffd54f,stroke:#fbc02d,stroke-width:2px
    </div>
</body>
</html>
